# Task ID: 6
# Title: Compose aeolian generator pipeline and masks export
# Status: pending
# Dependencies: 2, 3, 4, 5
# Priority: medium
# Description: Wire `generate_aeolian` to orchestrate morphology-specific builders, sedimentary overlays, palette application, and mask packaging for downstream stats/reporting.
# Details:
Implement dispatcher that selects Barchan/Linear/Transverse builders, applies Task 5 overlays, blends grayscale shading, and returns `(gray, masks_dict)` conforming to existing API. Ensure sequential layering order (base → ridges → slipfaces → interdunes → final gray → facies RGB) is emitted for preview and batch export. Write palette legend metadata aligned with `docs/PALETTES.md` and ensure mask keys align with reporting schema. Update docstrings with citations and keep GEOLOGIC_RULES compose row in sync.
Pseudo-code:
```
def generate_aeolian(params_dict):
    params = AeolianParams.from_dict(params_dict)
    base = make_base_field(params)
    builder = BUILDERS[params.env]
    gray, masks = builder(base, params)
    masks = apply_sedimentary_overlays(masks, params)
    legend = build_palette_metadata(masks)
    return gray, {**masks, "legend": legend}
```
Add CLI hook or utility to drive new generator for smoke tests.

# Test Strategy:
Create `tests/test_generate_aeolian.py` to run each env with fixed seed, asserting mask keys, grayscale ranges, sequential snapshot counts, and validating that overlays exist. Include regression fixtures (npz) for CI tolerance within ±1e-6.

# Subtasks:
## 1. Design generate_aeolian API and parameter ingestion [pending]
### Dependencies: None
### Description: Specify the public signature and behavior of generate_aeolian, including how it constructs AeolianParams from a generic params_dict and how callers are expected to pass env-specific settings.
### Details:
Define the generate_aeolian(params_dict: dict) function in `src/analog_image_generator/geologic_generators.py` as the main aeolian entrypoint used by interactive UI, stats, and reporting. Sketch how AeolianParams.from_dict will validate env, clamp ranges according to the existing AeolianParams schema from Task 1, and normalize any missing defaults. Document accepted keys, env values ("barchan", "linear", "transverse"), and error semantics (e.g., raising ValueError on invalid env). Ensure the function docstring clearly states that it returns `(gray, masks_dict)` and that masks_dict is JSON-serializable for downstream pipelines.

## 2. Implement Aeolian builder registry and env dispatch [pending]
### Dependencies: 6.1
### Description: Create a registry mapping env strings to morphology-specific builder functions and wire generate_aeolian to dispatch through this registry.
### Details:
Introduce a BUILDERS or AEOLIAN_BUILDERS dict in `geologic_generators.py` (or a nearby aeolian module) that maps canonical env names ("barchan", "linear", "transverse") to the generator functions implemented in Tasks 2–4, e.g., `build_barchan_field`, `build_linear_dune_field`, `build_transverse_dune_field`. Ensure the mapping is centralized so later code can introspect supported envs. In generate_aeolian, after constructing AeolianParams, look up the builder via this registry, handle unknown envs with a clear error, and call `gray, masks = builder(base, params)` using the base-field prepared from Task 1.

## 3. Integrate base-field creation, builders, and overlays into pipeline [pending]
### Dependencies: 6.1, 6.2
### Description: Wire together base-field generation, env-specific builders, and sedimentary overlays so generate_aeolian produces final gray and masks outputs conforming to the existing API.
### Details:
Call the base-field scaffolding from Task 1 (e.g., `make_base_field(params)` or equivalent) at the top of generate_aeolian, then feed its output plus AeolianParams into the selected builder from the registry. After the builder returns initial gray and masks, invoke the Task 5 overlay helpers via an `apply_sedimentary_overlays(masks, params)` or similar function that enriches masks with cross-bedding, grading, rounding, impacts, and cementation metadata. Ensure the final return value is `(gray_final, masks_dict)` where `gray_final` reflects any shading adjustments due to overlays and masks_dict contains all base morphology and overlay channels. Also design and implement a thin CLI hook or utility (e.g., in `scripts/` or an existing CLI module) that calls generate_aeolian with a small params set for smoke tests.

## 4. Define sequential stage ordering and storage schema [pending]
### Dependencies: 6.3
### Description: Specify and implement the ordered sequence of aeolian stages and how they are stored so interactive previews and batch exporters can reuse them.
### Details:
Within generate_aeolian (or a helper), formalize the stage list `['base', 'ridges', 'slipfaces', 'interdunes', 'gray_final', 'facies_rgb']` and ensure each stage is captured either as dedicated masks entries or as a structured sub-dict (e.g., `masks['stages']`). Decide on consistent keys and data types for each stage, making sure they are serializable to NPZ/JSON for batch workflows. Implement logic to populate this structure in the correct order as the pipeline runs: snapshot base field, then ridge masks, slipface masks, interdune maps, final gray, and facies RGB. Expose this ordering via a small helper (e.g., `get_aeolian_stage_order()`) so `interactive.py` and exporters can use the same canonical sequence.

## 5. Align masks, facies keys, and palette metadata with documentation [pending]
### Dependencies: 6.3, 6.4
### Description: Review mask naming, facies labels, and palette associations in generate_aeolian outputs and ensure they match docs/PALETTES.md and docs/TASKMASTER_TASKS_EXPORT.md.
### Details:
Cross-check the keys in the masks dict (e.g., crest, slipface, interdune, overlay channels, facies indices) against the schemas and naming conventions documented in `docs/PALETTES.md` and `docs/TASKMASTER_TASKS_EXPORT.md`. Update key names, facies IDs, and any palette lookups so that the aeolian outputs integrate cleanly with existing stats and reporting code. Ensure that any new overlay channels introduced by Task 5 use consistent prefixes or suffixes and are documented in a central place (e.g., a small AEOLIAN_MASK_SCHEMA mapping). Confirm that facies RGB representations tie back to palette entries and that no undocumented keys are emitted.

## 6. Implement legend and palette metadata helpers for reporting [pending]
### Dependencies: 6.5
### Description: Create legend metadata structures or helper functions that transform aeolian masks and palette info into a form that downstream reporting can render into PDFs and other artifacts.
### Details:
Design a `build_palette_metadata(masks, params)` helper (or similar) that collects the facies and overlay channels used by generate_aeolian, looks up their human-readable names and colors from `docs/PALETTES.md`, and returns a structured legend object, e.g., a list of entries with keys like `id`, `label`, `color`, and `category`. Integrate this helper into generate_aeolian so that the returned masks_dict includes a `legend` entry or nested structure suitable for CSV/PDF exporters. Ensure that the legend format is compatible with existing reporting functions (e.g., `reporting.build_reports`) and that it captures any aeolian-specific nuances such as cementation tints or cross-bedding indicators.

## 7. Update GEOLOGIC_RULES compose_aeolian row and documentation anchors [pending]
### Dependencies: 6.1, 6.3, 6.5, 6.6
### Description: Bring GEOLOGIC_RULES, docstrings, and notebook anchors up to date with the new generate_aeolian orchestration for full traceability.
### Details:
Edit `docs/GEOLOGIC_RULES.md` to update or add the compose_aeolian row so that it references the fully qualified `analog_image_generator.geologic_generators.generate_aeolian` function and describes its role in orchestrating aeolian morphology, overlays, and palettes. Ensure the corresponding notebook markdown anchors (e.g., `notebooks/aeolian.ipynb#anchor-aeolian-compose` or similar) reference the same function and principles, following the `anchor-<env>-<principle>` convention. Refresh relevant docstrings in `geologic_generators.py` and any CLI utilities to include citations, parameter descriptions, and notes about stage ordering and legend metadata, keeping everything consistent with the Notebook Anchors Discipline.

## 8. Add tests and regression harness for generate_aeolian across envs [pending]
### Dependencies: 6.3, 6.4, 6.5, 6.6, 6.7
### Description: Create tests/test_generate_aeolian.py with seed-stable tests for each env, covering output schema, value ranges, overlay presence, and regression stability, plus a simple smoke path used by CLI.
### Details:
Implement a new `tests/test_generate_aeolian.py` module that parametrizes over env values ("barchan", "linear", "transverse") and uses fixed seeds in AeolianParams. For each env, call generate_aeolian and assert that gray is within expected numeric ranges (e.g., 0–1 or 0–255, matching the rest of the project), masks_dict contains required base and overlay keys, and that overlay-specific invariants hold (e.g., at least some nonzero cross-bedding or cementation channels when enabled). Add regression fixtures (e.g., small NPZ files) capturing reference gray and key masks for one or more envs and compare current outputs with tolerances such as ±1e-6. Include a test that exercises the CLI smoke utility, verifying that it runs without error and that its outputs conform to the expected directory and file schema.
