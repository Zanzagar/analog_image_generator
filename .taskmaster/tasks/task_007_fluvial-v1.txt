# Task ID: 7
# Title: Build ipywidgets sliders, previews, and param batch (Interactive v20a)
# Status: pending
# Dependencies: 2, 3, 4, 6
# Priority: medium
# Description: Implement `interactive.py` to expose slider schemas per env, render sequential previews, show live β/D/H, and save lightweight param batches.
# Details:
- Define `build_sliders(env)` returning dicts with `min`, `max`, `step`, `default`, `units`, `source`, matching PRD table (use validated defaults from research PDFs).
- Compose ipywidgets UI: slider panel, preview button, seed input, stacked toggle, package mix multi-select.
- `preview_sequence(env, params, seeds)` should run generator/stacked builder, capture intermediate thumbnails (centerline, masks, final gray, color + legend), and compute quick β/D/H by calling lightweight subset of stats (Task 8) or placeholder until ready.
- Add `run_param_batch(env, slider_configs, seeds, output_dir)` saving grayscale + color PNGs.
- Provide sequential preview layout via `ipywidgets.HBox`/`VBox` with Matplotlib or Pillow for inline display.
- Ensure slider defaults validated against `research-documents` references, storing citation metadata for tooltips.
- Document usage in `notebooks/v20a_interactive_rebuild.ipynb` (markdown cell referencing anchor IDs).

# Test Strategy:
- Add `tests/test_interactive.py` verifying slider definitions match required ranges and default values, using pure-Python tests (no widget rendering) by asserting dictionaries.
- Use `pytest` with `ipywidgets` event loop to simulate slider change -> preview call (mock generator to avoid heavy compute) and ensure `preview_sequence` returns layout objects.
- Manual notebook smoke: run `v20a_interactive_rebuild.ipynb` to confirm live β/D/H updates; capture screenshot for documentation.

# Subtasks:
## 1. Design slider schema and implement build_sliders(env) in interactive.py [pending]
### Dependencies: None
### Description: Define a structured slider configuration schema and implement build_sliders(env) to return environment-specific slider definitions.
### Details:
In src/analog_image_generator/interactive.py, define a clear Python data structure (e.g., TypedDict or dataclass plus plain dicts) for slider configs with fields: name/key, label, min, max, step, default, units, source, citation_ids, and any env tags. Implement build_sliders(env: str) to return an ordered mapping of parameter keys to these config dicts for each supported env (e.g., meandering, braided, anastomosing, stacked). Seed initial ranges and defaults from the current PRD tables and research PDFs summaries (using existing constants or helper modules if available), but keep lookup logic separated so values can later be regenerated from a single source of truth. Ensure build_sliders is pure (no widget construction) and safe to call in tests and non-notebook contexts.

## 2. Implement ipywidgets-based UI factory using slider configs [pending]
### Dependencies: 7.1
### Description: Create composable ipywidgets UI components for sliders, seed input, stacked toggle, and package mix selectors.
### Details:
In interactive.py, add a function such as build_interactive_ui(env: str) or build_controls(env: str, slider_configs: Mapping) that uses ipywidgets (IntSlider, FloatSlider, Text/IntText, ToggleButtons/Checkbox, SelectMultiple, Button, etc.) to construct the interactive control panel. Map each slider config from build_sliders(env) to a corresponding widget, wiring labels, ranges, defaults, units in descriptions, and tooltip text from source/citation metadata. Include additional widgets for RNG seed input, stacked vs single-belt toggle, package_count and package mix multi-select controls, and a Preview button. Return a structured object (e.g., a dataclass or dict) containing both the widgets and a top-level VBox/HBox layout so notebooks can embed the panel easily without tightly coupling to notebook code.

## 3. Implement preview_sequence(env, params, seeds) with generator/stacked integration [pending]
### Dependencies: 7.1, 7.2
### Description: Wire preview_sequence to call the appropriate generators, capture intermediate artifacts, and return an ipywidgets layout of preview images.
### Details:
In interactive.py, implement preview_sequence(env: str, params: Mapping, seeds: Sequence[int]) to call the correct fluvial generator entry points (e.g., analog_image_generator.geologic_generators.generate_fluvial or a build_stacked_fluvial helper) based on env and the stacked toggle/package parameters. For each requested seed, run the generator to collect intermediate artifacts such as centerline representation, masks_dict, grayscale image, and a composited RGB image with color legend using existing visualization utilities or lightweight matplotlib/Pillow helpers in a separate, non-notebook-dependent module. Convert these artifacts into small inline preview images (e.g., via matplotlib FigureCanvas or PIL-to-Image widgets) and arrange them into a sequential HBox/VBox layout that shows centerline → masks → gray → color for each seed. Return both the widget layout and a structured data bundle (e.g., dict of arrays or paths) so callers can optionally reuse the raw outputs.

## 4. Add lightweight β/D/H metrics adapter for previews [pending]
### Dependencies: 7.3
### Description: Provide a fast adapter that computes or fetches β/D/H metrics for each preview run using existing stats code or a focused helper.
### Details:
Introduce a small helper in interactive.py or a dedicated stats adapter module (e.g., interactive_metrics.py) that accepts the generator outputs (centerline, masks, gray) and computes β/D/H metrics using a lightweight subset of stats.compute_metrics or a dedicated fast path that avoids full-report overhead. The adapter should handle the case where the full stats module or Task 8 is not yet complete by either importing a minimal metrics function or using a clearly marked placeholder that returns NaN or approximate values while logging a warning. Integrate this adapter into preview_sequence so each preview seed has associated β/D/H values that can be displayed next to or overlaid on the preview widgets (e.g., as Label widgets or text areas). Design the interface so that when stats.compute_metrics is fully implemented, only the adapter needs updating, not the UI code.

## 5. Implement run_param_batch(env, slider_configs, seeds, output_dir) for PNG and metadata export [pending]
### Dependencies: 7.1, 7.3, 7.4
### Description: Create a batch execution function that runs generators over parameter/seed grids and saves grayscale/color PNGs plus minimal metadata.
### Details:
In interactive.py, implement run_param_batch(env: str, slider_configs: Mapping, seeds: Sequence[int], output_dir: PathLike, params_overrides: Optional[Sequence[Mapping]] = None) that iterates over seeds and one or more parameter sets derived from the current slider configurations. For each run, call the same underlying generator or stacked builder used by preview_sequence, capture grayscale and colorized images, and save them as PNGs with deterministic filenames encoding env, seed, and a concise parameter hash. Additionally, serialize minimal JSON or CSV sidecar metadata per run (or one aggregated file) capturing env, seed, slider values, β/D/H metrics from the adapter, and citation/source tags used to define the parameters. Ensure the function creates output_dir if needed and is safe to call from both notebooks and scripts without relying on ipywidgets. Keep I/O logic separated from UI so it can be tested headlessly and used by reporting pipelines.

## 6. Validate slider ranges/defaults against PRD and research documents and attach citation metadata [pending]
### Dependencies: 7.1
### Description: Add validation utilities that check slider configs against PRD tables and research-documents and enrich configs with citation/source metadata.
### Details:
Implement a validation layer in interactive.py or a small helper module (e.g., slider_validation.py) that, given the slider configs from build_sliders(env), cross-checks min/max/default/step values against a structured representation of the PRD tables and any available research-documents summaries (e.g., JSON or constants already extracted from PDFs). The validator should raise clear exceptions or warnings when discrepancies exceed allowed tolerances, and it should populate each slider config with source fields and citation IDs (e.g., DOI, paper name, page/figure references) that can be used in ipywidgets tooltips. Expose a function like validate_slider_configs(env, slider_configs) and call it from build_sliders or immediately after in UI constructors so all interactive usage benefits from consistent validation and traceability.

## 7. Add tests for interactive slider data, preview plumbing, and batch execution [pending]
### Dependencies: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6
### Description: Create tests/test_interactive.py to cover slider definitions, UI wiring, preview_sequence behavior, metrics adapter integration, and run_param_batch.
### Details:
Populate tests/test_interactive.py with a focused test suite that treats slider configurations as pure data and exercises the main public entry points in interactive.py without expensive rendering. Include tests that: (a) verify build_sliders(env) returns only serializable, well-typed config dicts; (b) check that the UI factory returns the expected widgets and that changes in a widget’s value propagate into parameter dicts used for previews; (c) confirm preview_sequence returns a widget container plus structured artifacts, using mocked generators and metrics adapters; and (d) ensure run_param_batch writes PNGs and metadata files correctly to a temporary directory using mocked generators. Where necessary, use monkeypatching or lightweight fixtures to avoid importing Jupyter-specific modules beyond ipywidgets and to keep tests deterministic and fast.

## 8. Update v20a interactive notebook anchors and GEOLOGIC_RULES documentation for interactive.py [pending]
### Dependencies: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7
### Description: Revise notebooks/v20a_interactive_rebuild.ipynb and GEOLOGIC_RULES.md to document the new interactive sliders, previews, batch functions, and anchor mappings.
### Details:
Open notebooks/v20a_interactive_rebuild.ipynb and add or update markdown cells that describe how to import and use the new interactive functions (build_sliders, UI factory, preview_sequence, run_param_batch), including example code snippets and explanation of β/D/H display. Ensure each principle or behavior implemented in interactive.py has a corresponding notebook anchor ID following the anchor-<env>-<principle> convention and that these anchors reference fully qualified function names like analog_image_generator.interactive.build_sliders. In docs/GEOLOGIC_RULES.md, add or update rows that map geologic or UX principles to the new interactive functions and notebook anchors, keeping anchor IDs and terminology in sync. Verify that the notebook’s checklist and any task references reflect Task 7’s completion criteria and that documentation aligns with PRD and slider validation rules.

